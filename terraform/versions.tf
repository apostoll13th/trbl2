# =============================================================================
# versions.tf - Настройка Terraform и провайдеров
# =============================================================================
# Этот файл определяет:
# 1. Минимальную версию Terraform
# 2. Какие провайдеры (плагины) нужны для работы
# 3. Настройки подключения к VK Cloud
# =============================================================================

# -----------------------------------------------------------------------------
# Блок terraform {} - глобальные настройки Terraform
# -----------------------------------------------------------------------------
terraform {
  # Требуем Terraform версии 1.0.0 или выше
  # Почему: в версии 1.0 стабилизировался синтаксис и API
  required_version = ">= 1.0.0"

  # -----------------------------------------------------------------------------
  # required_providers - список провайдеров (плагинов) которые нужны
  # Провайдер = плагин который умеет работать с конкретным облаком/сервисом
  # -----------------------------------------------------------------------------
  required_providers {
    # Провайдер VK Cloud (бывший Mail.ru Cloud Solutions)
    vkcs = {
      # source - откуда скачивать провайдер
      # Формат: <namespace>/<name>, скачивается из registry.terraform.io
      source = "vk-cs/vkcs"

      # version - какую версию использовать
      # ~> 0.13.0 означает: >=0.13.0 и <0.14.0 (патч-версии разрешены)
      # Это защищает от breaking changes в новых минорных версиях
      version = "~> 0.13.0"
    }

    # Провайдер для работы с локальными файлами
    # Нужен чтобы генерировать Ansible inventory после создания VM
    local = {
      source  = "hashicorp/local"
      version = "~> 2.4"
    }
  }
}

# -----------------------------------------------------------------------------
# Блок provider "vkcs" - настройки подключения к VK Cloud
# -----------------------------------------------------------------------------
# Провайдер использует эти данные для аутентификации в API VK Cloud
# Все операции (создание VM, сетей и т.д.) выполняются через этот API
# -----------------------------------------------------------------------------
provider "vkcs" {
  # username - email от аккаунта VK Cloud
  # Берётся из переменной var.vkcs_username (задаётся в .env)
  username = var.vkcs_username

  # password - пароль от аккаунта VK Cloud
  # sensitive = true в переменной скрывает его в логах
  password = var.vkcs_password

  # project_id - ID проекта в VK Cloud
  # Можно найти в URL личного кабинета: /app/project/<PROJECT_ID>/...
  # Или в настройках проекта (вкладка Terraform)
  project_id = var.vkcs_project_id

  # region - регион дата-центра
  # RegionOne - основной регион VK Cloud (Москва)
  # Регион определяет физическое расположение серверов
  region = var.vkcs_region

  # auth_url - URL сервиса аутентификации (Keystone)
  # VK Cloud использует OpenStack, Keystone - его сервис авторизации
  # :35357 - стандартный admin порт Keystone
  # /v3/ - версия API (Identity API v3)
  auth_url = "https://infra.mail.ru:35357/v3/"

  # user_domain_id - ID домена пользователя в Keystone
  # "users" - стандартный домен для пользователей VK Cloud
  user_domain_id = "users"
}
